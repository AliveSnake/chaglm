#vit
import os
import sys
current_directory = os.getcwd()
efficientvit_path = os.path.abspath(os.path.join(current_directory, '..', 'model', 'vit'))
sys.path.append(efficientvit_path)
from efficientvit.cls_model_zoo import create_cls_model
import torch
from torchvision import transforms
from PIL import Image

# gpt
from transformers import AutoTokenizer, AutoModel

#加载模型
current_directory = os.path.dirname(__file__)
url = os.path.join(current_directory,'assets', 'checkpoints', 'cls','b1-r224.pt')
cls_model = create_cls_model(
  name="b1", weight_url=url
)
# tokenizer = AutoTokenizer.from_pretrained("chatglm3-6b-grape", trust_remote_code=True)
# gpt_model = AutoModel.from_pretrained("chatglm3-6b-grape", trust_remote_code=True, device='cpu')
# gpt_model = gpt_model.eval()

#vit
# 1. 加载图像
image_path1 = "./dataset/imagenet/test/Grape Leaf Blight.JPG"
image_path2 = "./dataset/imagenet/test/Grape_Black_rot.jpg"
image_path3 = "./dataset/imagenet/test/Grape___Esca_(Black_Measles).jpg"
image_path4 = "./dataset/imagenet/test/Grape_heathy.JPG"
image_path5 = "./dataset/imagenet/test/Grapevine_yellow.jpg"

def efficientvit(image_path):
    image = Image.open(image_path).convert("RGB")

    # 2. 图像预处理
    preprocess = transforms.Compose([
        transforms.Resize((288, 288)),
        transforms.ToTensor(),
        transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
    ])

    input_image = preprocess(image)
    input_batch = input_image.unsqueeze(0)  # 添加批量维度

    # 3. 模型推断
    with torch.no_grad():
        cls_model.eval()
        output = cls_model(input_batch)

    # 4. 获取预测结果
    probabilities = torch.nn.functional.softmax(output[0], dim=0)
    predicted_class = torch.argmax(probabilities).item()
    if predicted_class == 0:
        disease = "葡萄斑枯病"
    elif predicted_class == 1:
        disease = "葡萄黑腐病"
    elif predicted_class == 2:
        disease = "埃斯卡真菌感染（葡萄黑麻疹）"
    elif predicted_class == 3:
        disease = "葡萄健康"
    elif predicted_class == 4:
        disease = "葡萄黄化病"
    else:
        disease = "未知病害"

    #gpt
    instruction0 ="(1)加强果园管理冬剪后或落叶后彻底清除落叶，集中烧毁，消灭病菌越冬场所。生长季节及时打权、摘心，保持架面通风透光良好，防止果园郁闭，降低环境湿度，创造不利于病害发生的生态条件。\n(2)适当喷药防控灰斑病多为零星发生，—般不需单独进行喷药，结合其他病害防控兼防即可。个别上年病害发生较重的果园，从病害发生初期开始喷药，10-15天1次，连喷2次左右，即可有效控制其发生为害。效果较好的有效药剂有：50％异菌脲可湿性粉剂或45%悬浮剂1000-1500倍液、430克／升戊唑醇悬浮剂3000-4000倍液、10％苯酪甲环唑水分散粒剂1500-2000倍液、70％甲基硫菌灵（甲基托布津）可湿性粉剂或500克／升悬浮剂800-1000倍液、80％代森锰锌（太盛、大生，必得利）可湿性粉剂600~800倍液，30%戊唑．多菌灵（龙灯福连）悬浮剂700-800倍液、41％甲硫．戊唑醇悬浮剂600-700倍液等。"
    instruction1 ="黑腐病多为零星发生，在搞好果园卫生、清除病残体（将病僵果等病残体清出园外销毁）的基础上，—般不需单独药剂防控。个别受害较重的果园，结合炭疽病的防控进行喷药，即可完全控制该病的发生为害。\n常用有效药剂有：30％戊唑．多菌灵（龙灯福连）悬浮剂800-1000倍液、41%甲硫．戊唑醇悬浮剂600-800倍液、70％甲基硫菌灵（甲基托布津）可湿性粉剂或500克／升悬浮剂800-1000倍液、50％多菌灵可湿性粉剂或500克／升悬浮剂600-800倍液、10％苯酪甲环唑水分散粒剂2000-2500倍液、25％戊唑醇水乳剂2000-2500倍液、430克／升戊唑醇悬浮剂3000-4000倍液、70％丙森锌可湿性粉剂500-600倍液、60％唑酪．代森联水分散粒剂1000-1500倍液等。"
    instruction2 = "埃斯卡真菌感染的防治方法：埃斯卡真菌给全球范围的葡萄园，尤其是欧洲葡萄园带来负面影响最严重、最普遍的病害之一。葡萄园急救疗法从人类的牙医诊疗手段中得到灵感,采用先进的小型电锯切开葡萄藤主干,把被真菌感染的部分切除取出。这种方法可以保证优质葡萄酒的质量，又避免了拔除病株重新补种的费用，为葡萄酒公司节省资金。葡萄园急救疗法已经为全球知名的伊甘（Chateau d’Yquem）、 拉图（Chateau Latour）、酩悦（Moet&Chandon）等品牌的葡萄园解除了埃斯卡（esca）真菌感染的危害。"
    instruction3 =""
    instruction4 ="葡萄黄斑类病毒田间的传播方式不太清楚，可能通过嫁接传播和机械传播，Wah等（1999）发现其可以通过种子传播。葡萄黄斑类病毒通过农具，特别是刀具类(剪枝剪、嫁接刀、镰刀等)容易传染，因此，已污染园地刀具的彻底消毒，以防止其向健壮株的污染则更加重要。用1%福尔马林、1%NaOH、5%NaCl、5%Ca(OCl)2或5%Na3PO4等消毒液浸渍10分钟即可。除福尔马林外，其它4种消毒液均为pHl2以上的强碱。"

    if predicted_class == 0:
        instruction = instruction0
    elif predicted_class == 1:
        instruction = instruction1
    elif predicted_class == 2:
        instruction = instruction2
    elif predicted_class == 3:
        instruction = instruction3
    elif predicted_class == 4:
        instruction = instruction4
    else:
        disease = "未知病害"

    response0 = '''针对葡萄斑枯病的防治，你可以采取以下细节措施：
    (1)清除果园内落叶： 在冬剪后或落叶后，要及时清理果园内的落叶，将其集中烧毁。这有助于消灭病菌在落叶中的越冬场所，减少病害的传播。
    (2)加强果园管理： 生长季节要及时进行打权、摘心，保持架面通风透光良好。防止果园郁闭，降低环境湿度，创造不利于葡萄斑枯病发生的生态条件。
    (3)定期喷药防控： 对于个别上年病害发生较重的果园，可以从葡萄斑枯病发生初期开始定期喷药。建议每10-15天进行一次，连续喷2次左右，以有效控制病害的发生为害。
    (4)选择有效药剂： 选择效果较好的药剂进行喷药，常用的有效药剂包括50％异菌脲可湿性粉剂、45%悬浮剂的1000-1500倍液、430克／升的戊唑醇悬浮剂3000-4000倍液等。根据具体情况选择适当的药剂。
    (5)喷药时机： 喷药的时机要在病害发生初期，这样可以更有效地控制葡萄斑枯病的扩散。及时观察果园的病情，选择合适的时间进行喷药。
    (6)注意喷药频率： 喷药的频率要根据病情的严重程度而定，一般来说，每10-15天进行一次喷药，连续喷2次左右，可以有效地降低病害的风险。
    (7)注意药剂浓度： 使用药剂时要按照推荐浓度进行稀释，确保药剂的有效性，并避免对葡萄植株造成过度伤害。
    (8)轮作和间作： 在果园管理中引入轮作和间作，有助于打破病害的传播途径，降低葡萄斑枯病的发生概率。避免长期连作同一种植物，有助于维持果园的健康状况。
    (9)以上这些细节措施结合起来，可以有效地防治葡萄斑枯病，保护葡萄的生长和产量。
    '''

    response1 = '''针对葡萄黑腐病的防治，你可以采取以下细节措施：
    (1)维护果园卫生： 保持果园的卫生是防治黑腐病的首要步骤。及时清除果园内的病残体，特别是将病僵果等病残体清理出园外并进行销毁，以减少病源的存在。
    (2)定期检查病情： 常规巡查果园，特别是个别受害较重的果园，以及患有其他病害的果园。定期检查有助于及早发现黑腐病的发生，采取相应的防治措施。
    (3)结合其他病害防控进行喷药： 针对受害较重的果园，可以结合炭疽病的防控进行定期喷药，这有助于完全控制黑腐病的发生为害。
    (4)选择有效药剂： 常用的有效药剂包括30％戊唑多菌灵悬浮剂、41%甲硫戊唑醇悬浮剂、70％甲基硫菌灵可湿性粉剂或500克／升悬浮剂、50％多菌灵可湿性粉剂或500克／升悬浮剂等。根据具体情况选择适当的药剂。
    (5)喷药时机： 喷药的时机要在黑腐病发生初期，以及其他相关病害的喷药时机相结合，以更有效地控制病害的扩散。根据果园实际情况和气象条件确定合适的喷药时间。
    (6)注意喷药频率： 喷药的频率要根据病情的严重程度而定，一般来说，定期进行喷药，可以有效地降低黑腐病的风险。建议每10-15天进行一次，连续喷2次左右。
    (7)药剂浓度控制： 使用药剂时要按照推荐浓度进行稀释，确保药剂的有效性，并避免对葡萄植株造成过度伤害。
    (8)轮作和间作： 在果园管理中引入轮作和间作，有助于打破黑腐病的传播途径，降低病害的发生概率。避免长期连作同一种植物，有助于维持果园的健康状况。
    以上这些细节措施结合起来，可以有效地防治葡萄黑腐病，保护葡萄的生长和产量。
    '''

    response2 = '''针对葡萄埃斯卡真菌感染（葡萄黑麻疹），以下是详细的防治细节：
    (1)及时剪除感染部分： 仿效葡萄园急救疗法，一旦发现葡萄藤感染埃斯卡真菌，及时采用小型电锯切开主干，将被真菌感染的部分切除取出。这有助于阻断真菌的扩散，提高葡萄园的整体抵抗力。
    (2)采用手段确保质量： 通过手术式的切除感染部分，可以确保葡萄产出的果实质量，提高酿酒的品质。这是一种有效而保守的防治方式，尤其适用于高品质葡萄酒的生产。
    (3)定期巡查与监测： 建立定期的巡查机制，密切监测葡萄园的生长状况。及时发现埃斯卡真菌感染的迹象，以便迅速采取防治措施。
    (4)引入抗性品种： 选择埃斯卡真菌抗性较强的葡萄品种进行种植，以减少感染的可能性。这是长期的防治策略，有助于提高整个葡萄园的生态平衡。
    (5)合理施肥和水分管理： 维持适宜的土壤肥力和水分，有助于提高葡萄植株的健康状况，减少感染埃斯卡真菌的风险。
    (6)加强园地卫生： 定期清理果园内的落叶、残枝和其他植株残体，以减少病害源的存在，降低埃斯卡真菌的传播机会。
    (7)适时喷洒杀菌剂： 使用有效的杀菌剂，喷洒在葡萄植株上，以降低埃斯卡真菌的发生。应根据当地气候和葡萄生长季节选择合适的喷洒时机。
    (8)加强信息交流： 与其他葡萄园主、专业农业技术人员等建立信息交流渠道，分享防治经验和最新科研成果，共同提高对埃斯卡真菌感染的防治水平。
    综合以上细节措施，可以更全面地防治葡萄埃斯卡真菌感染，确保葡萄园的健康和生产。
    '''

    response3 = '''你的葡萄目前处于健康状态，恭喜！以下是保持和提高葡萄健康的一些建议：
    (1)定期巡查： 建立定期的巡查机制，仔细观察葡萄植株的生长状况，包括叶片、果穗和枝条等部位。早发现问题有助于及时采取措施。
    (2)保持园地清洁： 定期清理果园周围的落叶、枯枝等植物残体，以减少病害和害虫的滋生地。保持园地的整洁有助于维持葡萄园的卫生状况。
    (3)适时施肥： 根据土壤检测结果和葡萄植株的生长需求，合理施用有机或无机肥料。保持适宜的土壤养分水平，有助于提高葡萄的抵抗力。
    (4)科学浇水： 控制浇水的量和频率，避免水分过量或不足。保持土壤适度湿润，但避免积水，以减少病害的发生。
    (5)定期修剪和整形： 进行定期的修剪，保持葡萄植株的形状和结构良好。这有助于通风透光，减少湿度，预防一些真菌性病害。
    (6)引入天敌： 促进生态平衡，引入天敌如蜘蛛、瓢虫等有益昆虫，以帮助控制害虫的繁殖，减少对葡萄的损害。
    (7)注意病虫害防治： 定期检查葡萄植株，注意是否有病害和害虫的迹象。如发现问题，可采取有针对性的防治措施，比如使用合适的杀菌剂或昆虫防治剂。
    (8)合理支架管理： 对葡萄的支架进行适当的管理，确保枝条有足够的支撑，预防因果穗重压而导致的疾病和机械伤害。
    通过这些细节措施，你可以保持葡萄园的健康状态，提高葡萄的产量和品质。
    '''

    response4 = '''针对葡萄黄化病，以下是一些建议的防治细节：
    (1)彻底消毒农具： 由于葡萄黄斑类病毒容易通过农具传播，特别是刀具类，如剪枝剪、嫁接刀、镰刀等，因此应定期对已污染的园地刀具进行彻底消毒。可使用1%福尔马林、1%NaOH、5%NaCl、5%Ca(OCl)2或5%Na3PO4等消毒液，浸渍10分钟，以防止病毒传播。
    (2)防止嫁接传播： 注意防止葡萄黄斑类病毒通过嫁接传播。在进行嫁接操作时，确保使用经过消毒的工具，以降低传播的风险。
    (3)关注种子传播： 葡萄黄斑类病毒可能通过种子传播，因此要选择健康的种子，避免使用感染的种子，以降低病毒传播的概率。
    (4)提高园地卫生水平： 定期清理果园内的杂草和残枝残叶，减少病毒的隐匿地点，提高整体园地的卫生水平。
    (5)加强监测： 定期进行葡萄植株的监测，特别是对黄化病症状的早期发现，以便及时采取防治措施。
    (6)合理施肥和灌溉： 维持适宜的土壤肥力和水分，以提高葡萄植株的健康状况，增强其抵抗力，减轻病毒的侵害。
    (7)引入抗性品种： 选择对葡萄黄化病抗性较强的葡萄品种进行种植，以减少感染的可能性。
    (8)教育园丁和农户： 定期进行培训，提高园丁和农户对葡萄黄化病的认识，教育其正确的农业操作，避免病毒的传播。
    以上细节措施结合起来，有助于降低葡萄黄化病的风险，保护葡萄园的健康。
    '''

    if predicted_class == 0:
        response = response0
    elif predicted_class == 1:
        response = response1
    elif predicted_class == 2:
        response = response2
    elif predicted_class == 3:
        response = response3
    elif predicted_class == 4:
        response = response4
    else:
        response = "未知病害"
    
    return f"该叶片状态为{disease}。{response}"


# 5. 打印结果
# print(f"Predicted class: {predicted_class}")
# print(f"病害类型: {disease}")
#print(f"Class probabilities: {probabilities}")

#gpt
# ...

#vit
# ... (同上)

# #gpt
# instruction0 ="(1)加强果园管理冬剪后或落叶后彻底清除落叶，集中烧毁，消灭病菌越冬场所。生长季节及时打权、摘心，保持架面通风透光良好，防止果园郁闭，降低环境湿度，创造不利于病害发生的生态条件。\n(2)适当喷药防控灰斑病多为零星发生，—般不需单独进行喷药，结合其他病害防控兼防即可。个别上年病害发生较重的果园，从病害发生初期开始喷药，10-15天1次，连喷2次左右，即可有效控制其发生为害。效果较好的有效药剂有：50％异菌脲可湿性粉剂或45%悬浮剂1000-1500倍液、430克／升戊唑醇悬浮剂3000-4000倍液、10％苯酪甲环唑水分散粒剂1500-2000倍液、70％甲基硫菌灵（甲基托布津）可湿性粉剂或500克／升悬浮剂800-1000倍液、80％代森锰锌（太盛、大生，必得利）可湿性粉剂600~800倍液，30%戊唑．多菌灵（龙灯福连）悬浮剂700-800倍液、41％甲硫．戊唑醇悬浮剂600-700倍液等。"
# instruction1 ="黑腐病多为零星发生，在搞好果园卫生、清除病残体（将病僵果等病残体清出园外销毁）的基础上，—般不需单独药剂防控。个别受害较重的果园，结合炭疽病的防控进行喷药，即可完全控制该病的发生为害。\n常用有效药剂有：30％戊唑．多菌灵（龙灯福连）悬浮剂800-1000倍液、41%甲硫．戊唑醇悬浮剂600-800倍液、70％甲基硫菌灵（甲基托布津）可湿性粉剂或500克／升悬浮剂800-1000倍液、50％多菌灵可湿性粉剂或500克／升悬浮剂600-800倍液、10％苯酪甲环唑水分散粒剂2000-2500倍液、25％戊唑醇水乳剂2000-2500倍液、430克／升戊唑醇悬浮剂3000-4000倍液、70％丙森锌可湿性粉剂500-600倍液、60％唑酪．代森联水分散粒剂1000-1500倍液等。"
# instruction2 = "埃斯卡真菌感染的防治方法：埃斯卡真菌给全球范围的葡萄园，尤其是欧洲葡萄园带来负面影响最严重、最普遍的病害之一。葡萄园急救疗法从人类的牙医诊疗手段中得到灵感,采用先进的小型电锯切开葡萄藤主干,把被真菌感染的部分切除取出。这种方法可以保证优质葡萄酒的质量，又避免了拔除病株重新补种的费用，为葡萄酒公司节省资金。葡萄园急救疗法已经为全球知名的伊甘（Chateau d’Yquem）、 拉图（Chateau Latour）、酩悦（Moet&Chandon）等品牌的葡萄园解除了埃斯卡（esca）真菌感染的危害。"
# instruction3 =""
# instruction4 ="葡萄黄斑类病毒田间的传播方式不太清楚，可能通过嫁接传播和机械传播，Wah等（1999）发现其可以通过种子传播。葡萄黄斑类病毒通过农具，特别是刀具类(剪枝剪、嫁接刀、镰刀等)容易传染，因此，已污染园地刀具的彻底消毒，以防止其向健壮株的污染则更加重要。用1%福尔马林、1%NaOH、5%NaCl、5%Ca(OCl)2或5%Na3PO4等消毒液浸渍10分钟即可。除福尔马林外，其它4种消毒液均为pHl2以上的强碱。"

# if predicted_class == 0:
#     instruction = instruction0
# elif predicted_class == 1:
#     instruction = instruction1
# elif predicted_class == 2:
#     instruction = instruction2
# elif predicted_class == 3:
#     instruction = instruction3
# elif predicted_class == 4:
#     instruction = instruction4
# else:
#     disease = "未知病害"

# # 更新病害状态
# response, history = gpt_model.chat(
#     tokenizer,
#     f"你现在是葡萄病害防治助手。我提供给你一些资料作为参考：{instruction}。请保证使用中文回答问题，我的葡萄目前状态是：{disease}，我该如何防治？详细描述其中具体的细节,内容不少于八条",
#     history=[]
# )
# # 打印模型生成的回答
# print("助手:", response)
# while True:
#     # 给出指导性说明

#     # 用户输入
#     user_input = input("用户: ")

#     # 判断是否退出循环
#     if user_input.lower() == 'exit':
#         break

#     # 打印模型生成的回答
#     print("助手:", response)
